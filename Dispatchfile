#!mesosphere/dispatch-starlark:v0.6
# vi:syntax=python
load("github.com/mesosphere/dispatch-catalog/starlark/stable/pipeline@0.0.7", "cron")
load("github.com/mesosphere/dispatch-tasks/bump_charts/bump_charts@master", "bump_charts")
load("github.com/mesosphere/dispatch-catalog/starlark/stable/docker@0.0.4", "dindTask")
load("github.com/mesosphere/dispatch-catalog/starlark/stable/git@0.0.7", "git_resource")
load("github.com/mesosphere/dispatch-catalog/starlark/stable/k8s@0.0.7", "secret_var")
load("github.com/mesosphere/dispatch-catalog/starlark/stable/pipeline@0.0.7", "pull_request")


git = "src-git"
git_resource(git, url="https://github.com/mesosphere/kubeaddons-enterprise", revision="$(context.git.commit)")

ui = "ui-git"
git_resource(ui, url="git@github.com:mesosphere/kommander.git", revision="v6.37.0")

resource("artifacts", type="storage", params={
    "type": "gcs",
    "location": "s3://artifacts",
    "dir": "yes"
}, secrets={
    "BOTO_CONFIG": k8s.corev1.SecretKeySelector(key="boto", localObjectReference=k8s.corev1.LocalObjectReference(name="s3-config"))
})


dindTask("dispatch-e2e-test",
    inputs=[git, ui],
    outputs=["artifacts"],
    steps=[
        v1.Container(
            name="fetch-master",
            image="mesosphere/dispatch-dind:v0.5.2",
            workingDir="/workspace/" + git,
            args=["git", "fetch", "origin", "master"]),

        v1.Container(
            name="run-e2e-tests",
            image="mesosphere/kommander-ci:1045-0bc7580",
            workingDir="/workspace/" + git,
            resources=k8s.corev1.ResourceRequirements(
                limits={
                    "cpu": k8s.resource_quantity("8000m"),
                    "memory": k8s.resource_quantity("6Gi")
                }
            ),
            env=[
                k8s.corev1.EnvVar(name="DISPATCH_CI", value="true"),
                k8s.corev1.EnvVar(name="OUTPUT_PATH", value="$(resources.outputs.artifacts.path)"),
                k8s.corev1.EnvVar(name="AWS_REGION", value="us-west-2"),
                k8s.corev1.EnvVar(name="AWS_ACCESS_KEY", valueFrom=secret_var("rotator-ksphere-kommander", "AWS_ACCESS_KEY_ID")),
                k8s.corev1.EnvVar(name="AWS_SECRET_KEY", valueFrom=secret_var("rotator-ksphere-kommander", "AWS_SECRET_ACCESS_KEY")),
                k8s.corev1.EnvVar(name="AWS_ACCESS_KEY_ID", valueFrom=secret_var("rotator-ksphere-kommander", "AWS_ACCESS_KEY_ID")),
                k8s.corev1.EnvVar(name="AWS_SECRET_ACCESS_KEY", valueFrom=secret_var("rotator-ksphere-kommander", "AWS_SECRET_ACCESS_KEY")),
                k8s.corev1.EnvVar(name="LICENSE", valueFrom=secret_var("kommander-license", "LICENSE")),
                k8s.corev1.EnvVar(name="COMMIT", value="$(context.git.commit)"),
                k8s.corev1.EnvVar(name="COMMIT_INFO_BRANCH", value="$(context.git.branch)"),
                k8s.corev1.EnvVar(name="COMMIT_INFO_SHA", value="$(context.git.commit)")
            ],
            command=["/entrypoint.sh", "./test/scripts/e2e.sh", "$(context.git.branch)"]),
    ])


do_bump_charts = bump_charts(repo_name="kubeaddons-enterprise", task_name="bump-charts")
action(name="bump-charts", on=cron(schedule="0 3 * * 5"), tasks=[do_bump_charts])

action(tasks=["dispatch-e2e-test"], on=pull_request())
action(tasks=["dispatch-e2e-test"], on=pull_request(chatops=["test-e2e"]))
